<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metronome</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      min-height: 100vh;
      box-sizing: border-box;
    }
    h1 {
      margin: 0 0 20px 0;
      font-size: 2em;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .bpm-display {
      font-size: 8em;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
      font-variant-numeric: tabular-nums;
    }
    .bpm-slider-container {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .bpm-slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 20px;
      background: #333;
      border-radius: 10px;
      outline: none;
    }
    .bpm-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 40px;
      height: 40px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
    }
    .bpm-slider::-moz-range-thumb {
      width: 40px;
      height: 40px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    .bpm-input {
      width: 80px;
      padding: 10px;
      font-size: 1.2em;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      text-align: center;
    }
    .settings-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .setting-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .setting-label {
      color: #888;
    }
    select {
      padding: 10px 14px;
      font-size: 1em;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      cursor: pointer;
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .control-label {
      color: #aaa;
      min-width: 90px;
    }
    .control-input {
      width: 70px;
      padding: 10px;
      font-size: 1em;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      text-align: center;
    }
    .control-unit {
      color: #666;
    }
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .checkbox-row input[type="checkbox"] {
      width: 24px;
      height: 24px;
      accent-color: #fff;
      cursor: pointer;
    }
    .checkbox-label {
      color: #ddd;
      cursor: pointer;
    }
    .auto-increment-options {
      display: none;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      margin-bottom: 20px;
    }
    .auto-increment-options.visible {
      display: block;
    }
    .start-btn {
      width: 100%;
      padding: 20px;
      font-size: 1.5em;
      font-weight: bold;
      background: #2a2;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .start-btn:hover {
      background: #3b3;
    }
    .start-btn.running {
      background: #c33;
    }
    .start-btn.running:hover {
      background: #d44;
    }
    .beat-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    .beat-dot {
      width: 20px;
      height: 20px;
      background: #333;
      border-radius: 50%;
      transition: background 0.05s;
    }
    .beat-dot.active {
      background: #fff;
    }
    .stats {
      text-align: center;
      color: #666;
      font-size: 0.9em;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="bpm-display" id="bpmDisplay">120</div>

    <div class="bpm-slider-container">
      <input type="range" class="bpm-slider" id="bpmSlider" min="20" max="300" value="120">
      <input type="number" class="bpm-input" id="bpmInput" min="20" max="300" value="120">
    </div>

    <div class="settings-row">
      <div class="setting-group">
        <span class="setting-label">Time</span>
        <select id="timeSignature">
          <option value="2">2/4</option>
          <option value="3">3/4</option>
          <option value="4" selected>4/4</option>
          <option value="5">5/4</option>
          <option value="6">6/8</option>
          <option value="7">7/8</option>
        </select>
      </div>
      <div class="setting-group">
        <span class="setting-label">Sound</span>
        <select id="soundType">
          <option value="beep">Beep</option>
          <option value="click">Click</option>
          <option value="woodblock">Wood Block</option>
          <option value="cowbell">Cowbell</option>
        </select>
      </div>
    </div>

    <div class="beat-indicator" id="beatIndicator">
      <div class="beat-dot"></div>
      <div class="beat-dot"></div>
      <div class="beat-dot"></div>
      <div class="beat-dot"></div>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="autoIncrementEnabled">
      <label class="checkbox-label" for="autoIncrementEnabled">Auto tempo increase</label>
    </div>

    <div class="auto-increment-options" id="autoIncrementOptions">
      <div class="control-row">
        <span class="control-label">Increment by</span>
        <input type="number" class="control-input" id="incrementAmount" min="1" max="50" value="5">
        <span class="control-unit">BPM</span>
      </div>
      <div class="control-row">
        <span class="control-label">Every</span>
        <input type="number" class="control-input" id="incrementInterval" min="1" max="999" value="10">
        <select id="incrementMode">
          <option value="beats">beats</option>
          <option value="seconds" selected>seconds</option>
        </select>
      </div>
    </div>

    <button class="start-btn" id="startBtn">START</button>

    <div class="stats" id="stats"></div>
  </div>

  <script>
    // Audio context and sounds
    let audioCtx = null;
    
    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    // Sound generators
    function playBeep(accent = false) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = accent ? 1000 : 800;
      osc.type = 'sine';
      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(accent ? 0.3 : 0.2, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
      osc.start(now);
      osc.stop(now + 0.1);
    }

    function playClick(accent = false) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(audioCtx.destination);
      osc.type = 'square';
      osc.frequency.value = accent ? 2500 : 2000;
      filter.type = 'highpass';
      filter.frequency.value = 1000;
      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(accent ? 0.15 : 0.1, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.02);
      osc.start(now);
      osc.stop(now + 0.02);
    }

    function playWoodblock(accent = false) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(audioCtx.destination);
      osc.type = 'sine';
      const baseFreq = accent ? 800 : 600;
      osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(baseFreq * 0.5, audioCtx.currentTime + 0.1);
      filter.type = 'bandpass';
      filter.frequency.value = baseFreq;
      filter.Q.value = 10;
      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(accent ? 0.4 : 0.3, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
      osc.start(now);
      osc.stop(now + 0.1);
    }

    function playCowbell(accent = false) {
      const osc1 = audioCtx.createOscillator();
      const osc2 = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      osc1.connect(filter);
      osc2.connect(filter);
      filter.connect(gain);
      gain.connect(audioCtx.destination);
      // Cowbell uses two detuned square waves
      osc1.type = 'square';
      osc2.type = 'square';
      const baseFreq = accent ? 800 : 560;
      osc1.frequency.value = baseFreq;
      osc2.frequency.value = baseFreq * 1.5;
      filter.type = 'bandpass';
      filter.frequency.value = baseFreq * 1.2;
      filter.Q.value = 3;
      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(accent ? 0.2 : 0.15, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
      osc1.start(now);
      osc2.start(now);
      osc1.stop(now + 0.3);
      osc2.stop(now + 0.3);
    }

    function playSound(accent = false) {
      if (!audioCtx) return;
      const soundType = document.getElementById('soundType').value;
      switch (soundType) {
        case 'beep': playBeep(accent); break;
        case 'click': playClick(accent); break;
        case 'woodblock': playWoodblock(accent); break;
        case 'cowbell': playCowbell(accent); break;
      }
    }

    // State
    let isRunning = false;
    let currentBpm = 120;
    let beatCount = 0;
    let startTime = 0;
    let nextBeatTime = 0;
    let timerInterval = null;
    let lastIncrementBeat = 0;
    let lastIncrementTime = 0;

    // DOM elements
    const bpmDisplay = document.getElementById('bpmDisplay');
    const bpmSlider = document.getElementById('bpmSlider');
    const bpmInput = document.getElementById('bpmInput');
    const startBtn = document.getElementById('startBtn');
    const beatIndicator = document.getElementById('beatIndicator');
    const stats = document.getElementById('stats');
    const timeSignature = document.getElementById('timeSignature');
    
    const autoIncrementEnabled = document.getElementById('autoIncrementEnabled');
    const autoIncrementOptions = document.getElementById('autoIncrementOptions');
    const incrementAmount = document.getElementById('incrementAmount');
    const incrementInterval = document.getElementById('incrementInterval');
    const incrementMode = document.getElementById('incrementMode');

    // BPM control
    function setBpm(bpm, updateInputs = true) {
      bpm = Math.max(20, Math.min(300, Math.round(bpm)));
      currentBpm = bpm;
      bpmDisplay.textContent = bpm;
      if (updateInputs) {
        bpmSlider.value = bpm;
        bpmInput.value = bpm;
      }
    }

    bpmSlider.addEventListener('input', () => {
      setBpm(parseInt(bpmSlider.value), false);
      bpmInput.value = currentBpm;
    });

    bpmInput.addEventListener('change', () => {
      setBpm(parseInt(bpmInput.value), false);
      bpmSlider.value = currentBpm;
    });

    // Auto increment toggle
    autoIncrementEnabled.addEventListener('change', () => {
      autoIncrementOptions.classList.toggle('visible', autoIncrementEnabled.checked);
    });

    // Time signature - update beat indicator
    function updateBeatDots() {
      const beats = parseInt(timeSignature.value);
      beatIndicator.innerHTML = '';
      for (let i = 0; i < beats; i++) {
        const dot = document.createElement('div');
        dot.className = 'beat-dot';
        beatIndicator.appendChild(dot);
      }
    }

    timeSignature.addEventListener('change', updateBeatDots);

    // Beat indicator
    function updateBeatIndicator(beat) {
      const beats = parseInt(timeSignature.value);
      const dots = beatIndicator.querySelectorAll('.beat-dot');
      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === beat % beats);
      });
    }

    // Metronome logic
    function tick() {
      const now = performance.now();
      const beats = parseInt(timeSignature.value);
      
      while (nextBeatTime <= now) {
        const beatInMeasure = beatCount % beats;
        playSound(beatInMeasure === 0);
        updateBeatIndicator(beatInMeasure);
        
        beatCount++;
        
        // Check for auto increment
        if (autoIncrementEnabled.checked && currentBpm < 300) {
          const increment = parseInt(incrementAmount.value) || 5;
          const interval = parseInt(incrementInterval.value) || 10;
          const mode = incrementMode.value;
          
          let shouldIncrement = false;
          
          if (mode === 'beats') {
            if (beatCount - lastIncrementBeat >= interval) {
              shouldIncrement = true;
              lastIncrementBeat = beatCount;
            }
          } else {
            const elapsedSeconds = (now - lastIncrementTime) / 1000;
            if (elapsedSeconds >= interval) {
              shouldIncrement = true;
              lastIncrementTime = now;
            }
          }
          
          if (shouldIncrement) {
            setBpm(Math.min(currentBpm + increment, 300));
          }
        }
        
        // Calculate next beat time
        const beatDuration = 60000 / currentBpm;
        nextBeatTime += beatDuration;
      }
      
      // Update stats
      const elapsed = (now - startTime) / 1000;
      const mins = Math.floor(elapsed / 60);
      const secs = Math.floor(elapsed % 60);
      stats.textContent = `Beat ${beatCount} | ${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function start() {
      initAudio();
      
      isRunning = true;
      beatCount = 0;
      startTime = performance.now();
      nextBeatTime = startTime;
      lastIncrementBeat = 0;
      lastIncrementTime = startTime;
      
      startBtn.textContent = 'STOP';
      startBtn.classList.add('running');
      
      tick(); // First beat immediately
      timerInterval = setInterval(tick, 10);
    }

    function stop() {
      isRunning = false;
      
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      
      startBtn.textContent = 'START';
      startBtn.classList.remove('running');
      
      // Reset beat indicator
      const dots = beatIndicator.querySelectorAll('.beat-dot');
      dots.forEach(dot => dot.classList.remove('active'));
      
      stats.textContent = '';
    }

    startBtn.addEventListener('click', () => {
      if (isRunning) {
        stop();
      } else {
        start();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
        e.preventDefault();
        if (isRunning) {
          stop();
        } else {
          start();
        }
      }
    });

    // Wake Lock to prevent device from sleeping
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            console.log('Wake Lock released');
          });
        }
      } catch (err) {
        console.log('Wake Lock error:', err.message);
      }
    }
    
    requestWakeLock();
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        requestWakeLock();
      }
    });

    // LocalStorage persistence
    const STORAGE_KEY = 'metronome_prefs';
    
    function savePrefs() {
      const prefs = {
        bpm: currentBpm,
        timeSignature: timeSignature.value,
        soundType: document.getElementById('soundType').value,
        autoIncrement: autoIncrementEnabled.checked,
        incrementAmount: incrementAmount.value,
        incrementInterval: incrementInterval.value,
        incrementMode: incrementMode.value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
    }
    
    function loadPrefs() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          const prefs = JSON.parse(stored);
          if (prefs.bpm) setBpm(prefs.bpm);
          if (prefs.timeSignature) timeSignature.value = prefs.timeSignature;
          if (prefs.soundType) document.getElementById('soundType').value = prefs.soundType;
          if (prefs.autoIncrement !== undefined) {
            autoIncrementEnabled.checked = prefs.autoIncrement;
            autoIncrementOptions.classList.toggle('visible', prefs.autoIncrement);
          }
          if (prefs.incrementAmount) incrementAmount.value = prefs.incrementAmount;
          if (prefs.incrementInterval) incrementInterval.value = prefs.incrementInterval;
          if (prefs.incrementMode) incrementMode.value = prefs.incrementMode;
        }
      } catch (e) {
        console.log('Could not load preferences:', e);
      }
    }
    
    // Add change listeners to save preferences
    bpmSlider.addEventListener('change', savePrefs);
    bpmInput.addEventListener('change', savePrefs);
    timeSignature.addEventListener('change', savePrefs);
    document.getElementById('soundType').addEventListener('change', savePrefs);
    autoIncrementEnabled.addEventListener('change', savePrefs);
    incrementAmount.addEventListener('change', savePrefs);
    incrementInterval.addEventListener('change', savePrefs);
    incrementMode.addEventListener('change', savePrefs);

    // Initialize
    loadPrefs();
    updateBeatDots();
  </script>
</body>
</html>
